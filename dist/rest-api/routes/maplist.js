"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MapListsGenerator = void 0;
const google_spreadsheet_1 = require("google-spreadsheet");
const plugin = async function (app, { config, db, redis }) {
    app.route({
        method: "GET",
        url: "/mapLists.conf",
        handler: async (request, reply) => {
            const mapListsGenerator = new MapListsGenerator({
                googleSheetsId: config.maplists.googleSheetsId,
                googleSheetsAPIKey: config.maplists.googleSheetsAPIKey
            });
            reply.header("Content-Disposition", "inline; filename=mapLists.conf");
            const mapLists = await mapListsGenerator.generate();
            return mapLists.mapListsStr;
        },
    });
};
class MapListsGenerator {
    constructor(config) {
        this.config = config;
        this.doc = new google_spreadsheet_1.GoogleSpreadsheet(this.config.googleSheetsId);
    }
    async generate() {
        this.doc.useApiKey(this.config.googleSheetsAPIKey);
        await this.doc.loadInfo();
        const sheet = this.doc.sheetsByIndex[0];
        await sheet.loadCells();
        const rawHeadingColIndexes = {};
        for (let x = 2; x < sheet.columnCount; x++) {
            const cellVal = sheet.getCell(2, x).value;
            if (cellVal) {
                rawHeadingColIndexes[cellVal.toString()] = x;
            }
        }
        const headingColIndex = {
            fileName: 2,
            name: 3,
            width: rawHeadingColIndexes["sizeX"],
            height: rawHeadingColIndexes["sizeY"],
            duel: rawHeadingColIndexes["1v1"],
            team: rawHeadingColIndexes["Teams"],
            ffa: rawHeadingColIndexes["FFA"],
            certified: rawHeadingColIndexes["Certified?"],
            inPool: rawHeadingColIndexes["Is in pool"],
            playerCount: rawHeadingColIndexes["Player Count"],
            teamCount: rawHeadingColIndexes["Team Count"],
        };
        const mapPools = {
            certified: [],
            uncertified: [],
            small: [],
            medium: [],
            large: [],
            extraLarge: [],
            duel: [],
            team: {},
            ffa: {},
            teamffa: {},
            misc: []
        };
        for (let y = 3; y < sheet.rowCount; y++) {
            const map = {};
            Object.entries(headingColIndex).forEach(([key, dataIndex]) => {
                map[key] = sheet.getCell(y, dataIndex).value;
            });
            if (map.inPool != 1 || map.width == null || map.height == null || map.playerCount == null || map.teamCount == null) {
                if (map.name != null) {
                    mapPools.misc.push(map.name);
                }
                continue;
            }
            if (map.certified == 1) {
                mapPools.certified.push(map.name);
            }
            else {
                mapPools.uncertified.push(map.name);
            }
            const totalSize = map.width + map.height;
            if (totalSize <= 24) {
                mapPools.small.push(map.name);
            }
            else if (totalSize <= 40) {
                mapPools.medium.push(map.name);
            }
            else if (totalSize <= 56) {
                mapPools.large.push(map.name);
            }
            else {
                mapPools.extraLarge.push(map.name);
            }
            let addedToPresetPool = false;
            if (map.duel == 1) {
                mapPools.duel.push(map.name);
                addedToPresetPool = true;
            }
            if (map.team == 1 && map.teamCount == 2 && map.teamCount % 2 === 0) {
                if (mapPools.team[map.playerCount] === undefined) {
                    mapPools.team[map.playerCount] = [];
                }
                mapPools.team[map.playerCount].push(map.name);
                addedToPresetPool = true;
            }
            if (map.ffa == 1) {
                if (mapPools.ffa[map.playerCount] === undefined) {
                    mapPools.ffa[map.playerCount] = [];
                }
                mapPools.ffa[map.playerCount].push(map.name);
                addedToPresetPool = true;
            }
            if (map.ffa == 1 && map.team == 1) {
                if (mapPools.teamffa[map.playerCount] === undefined) {
                    mapPools.teamffa[map.playerCount] = [];
                }
                mapPools.teamffa[map.playerCount].push(map.name);
                addedToPresetPool = true;
            }
            if (!addedToPresetPool) {
                mapPools.misc.push(map.name);
            }
        }
        return {
            mapPools: mapPools,
            mapListsStr: this.getMapListsConf(mapPools)
        };
    }
    getMapListsConf(mapPools) {
        const header = `# This file was automatically generated by bar-maplists-generator using data from https://docs.google.com/spreadsheets/d/1rn4kIIc9Nnyv_ZiBxXvNXdhUSnh15aLrLsQXmtUBJt8/edit#gid=0
[all]
.*
`;
        let pools = "";
        Object.entries(mapPools).forEach(([key, val]) => {
            if (Array.isArray(val) && val.length) {
                pools += `\n[${key}]\n`;
                val.forEach(map => {
                    pools += `${map}\n`;
                });
            }
            else {
                Object.entries(val).forEach(([playerCount, val2]) => {
                    if (Array.isArray(val2) && val2.length) {
                        let betterKey = key;
                        pools += `\n[${key}${playerCount}]\n`;
                        val2.forEach(map => {
                            pools += `${map}\n`;
                        });
                    }
                });
            }
        });
        return `${header}${pools}`;
    }
}
exports.MapListsGenerator = MapListsGenerator;
exports.default = plugin;
//# sourceMappingURL=maplist.js.map